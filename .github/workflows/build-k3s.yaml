name: Build K3s

on: 
  push:

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    steps:
    - name: Checkout K3s
      uses: actions/checkout@v3
    - name: Build K3s binary
      run: |

        apt update -yqq
        apt install -yqq golang 

        sed -i '#staging/src/k8s.io/node-api#d' go.mod
        sed -i 's#github.com/k3s-io/kubernetes#github.com/salyh/kubernetes#g' go.mod
        sed -i 's#v1.27.4-k3s1#release_v1.27.4#g' go.mod

        go mod tidy -v -x && go mod verify

        git config --global user.name "CI"
        git config --global user.email "ci@users.noreply.github.com"
        git commit -a -m "Update go.mod to point to github.com/salyh/kubernetes"
        git push

        DOCKER_BUILDKIT=1 SKIP_AIRGAP=1 SKIP_VALIDATE=1 GOCOVER=1 make
      
    - name: "Upload K3s binary"
      uses: actions/upload-artifact@v3
      with:
        name: k3s
        path: dist/artifacts/k3s